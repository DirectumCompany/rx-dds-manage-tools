# Как работать над несколькими проектами прикладной разработки RX на одном рабочем месте разработчика

## Для Directum RX 4.2

Подготовка RX для переключения между проектами:

1. После установки RX 4.2 с помощью Directum Launcher необходимо установить компоненту Manage Applied Solution. Для этого перейдите в папку Directum Launcher и выполните команду:

```
do.bat components add_package <путь к текущему репозиторию>\ManageAppProjects_Component.zip
```

2. Доработать стандартный config.yml:

* в группу variables добавить:
  * переменную purpose, в которую будет записываться назначение проекта
  * переменную database, в которую будет записываться имя базы данных проекта
* в параметре common_config->CONNECTION_STRING использовать переменную database для задания базы данных
* "из коробки" каталог для логов сконфигурирован в домашний каталог проекта. Рекомендуется указать абсолютный путь, чтобы при переключении между проектами логи писались в одно место - см. параметр logs_path -> LOGS_PATH
* "из коробки" сертификат для связи сервисов используется свой для каждого проекта - см. папку data_protection в домашнем каталоге проекта. Для упрощения переключения между проектами рекомендуется рекомендуется настроить так, чтобы у всех проектов использовался один сертификат. Для этого нужно перенести папку data_protection из домашнего каталога и изменить значение параметра common_config -> DATA_PROTECTION_CERTIFICATE_FILE.

Принцип использования компоненты Manage Applied Solution для переключения между проектами:

* с помощью команды `do map generate_empty_project_config <путь к файлу описания проекта>` создать файл описания проекта командой. По структуре этот файл похож на стандартный config.yml и принцип его заполнения такой же.
* задать значения переменным в файле описания проекта
* переключиться на проект командой `do map set <путь к файлу описания проекта> `. В результате будет скорректирован config.yml, обновлены конфиги сервисов и компонент и перезапущены сервисы RX.

Дополнительные возможности компоненты можно посмотреть командой `do map help`.

## Для Directum RX 3.3 - 4.1

"Из коробки" рабочее место разработчика рассчитано на работу над одним проектом (БД + исходники + каталог хранилища документов и сервиса предпросмотра) на одной версии RX, установленной на компьютере. На практике разработчикам нужна возможность оперативного переключения между разными проектами как внутри одной версии RX, так и между разными версиями RX.  

Использование виртуальных машин под каждый проект решает эту задачу, но имеет ряд проблем:

* для более менее комфортной работы требуется выделять значительные ресурсы - оперативную память, процессор, место на SSD диске, что дорого;
* развертывание виртуальной машины и установка на ней нужной версии RX - довольно длительная процедура.

Ниже будет описан подход, который позволяет оперативно переключаться между разными проектами на одном рабочем месте разработчика с  помощью скриптов https://github.com/DirectumCompany/rx-dds-manage-tools.

Хотя скрипты имеют достаточно высокую степень гибкости настроек для удобства работы рекомендуется придерживаться определенных правил развертывания среды разработки RX, которая позволит использовать скрипты as is. Ниже описаны основные этапы развертывания среды разработки:

1. Установка первой версии RX на рабочем месте разработчика
2. Создание описания эталонного проекта
3. Создание первого рабочего проекта на основе эталонного
4. Подготовка к установке второй версии RX
5. Установка второй версии RX

### 1. Установка первой версии RX

При установке первой рекомендуется придерживаться следующих принципов

* имена отладочных сервера приложения и веб-клиента - предлагаемые по-умолчанию инсталлятором
* корневой каталог для исходников задается в виде: <диск>:\\< корневой каталог для исходников всех версий RX>\\< корневой каталог для исходников конкретной версии RX>
* в имени БД указать номер версии. Например, rx_3355_clr
* каталоги хранилища документов и сервиса предпросмотра находятся внутри одного каталога, который задается в виде: <диск>:\\< корневой каталог для папок документов всех версий RX>\\< корневой каталог для документов конкретной версии RX>\\< корневой каталог для документов конкретного проекта> и имеют следующие имена:
  * DocStorage - каталог хранилища документов
  * PreviewTemp - каталог временных файлов предпросмотра
  * PreviewSource - каталог для исходных документов
  * PreviewDebug - каталог отладочного сервиса предпросмотра

Например, в результате установки RX 3.3.55 будут созданы следующие каталоги

```
C:\
  RX\
    3355\
      Base
      Work
  RXData
    3355\
      clr_3355\
        DocStorage
        PreviewTemp
        PreviewSource
        PreviewDebug
```

Рекомендуется сразу создать резервные копии как БД, так и папок хранилища документов и сервиса предпросмотра.

### 2. Создание описания эталонного проекта

После установки необходимо создать описание проекта:

1. Скопировать каталог Base в Box. Каталог Box будет использоваться в качестве каталога с исходниками коробочных модулей
2. Переименовать каталоги Base и Work в clr_Base и clr_Work
3. Скопировать шаблон описания проекта для соответствующей версии RX из rx-dds-manage-tools\samples в  корневой каталог исходников конкретной версии RX. Например для версии 3.3: rx-dds-manage-tools\samples\sample_config_rx33.xml  --> c:\RX\3355\c_clr3355.xml
4. Корректно заполнить созданный файл описания эталонного проекта (c:\RX\3355\c_clr3355.xml). Для этого задать значения следующим переменным конфигурационного файла:
   * !DATABASE! - имя БД. Заполняется значением параметра 'Initial Catalog' переменной CONNECTION_STRING из DirectumRxWebLocal\api\\_ConfigSettings.xml.
   * !DOC_ROOT_DIRECTORY! - каталог, который использовался в качестве корневого для DocStorage, PreviewTemp, PreviewSource, PreviewDebug. В приведенном выше примере - C:\RXData\3355\clr_3355
   * !GIT_ROOT_DIRECTORY! - каталог, который использовался в качестве рабочей папки. В приведенном выше примере - C:\RX\3355\
   * REPOSITORIES - В секции задаются названия папок, в которых хранятся копии исходных кодов базовых и разрабатываемых решений. Оставить указанными значениями
   * !DATABASE_SERVER! - сервер БД. Заполняется значением параметра 'Data Source' переменной CONNECTION_STRING из DirectumRxWebLocal\api\\_ConfigSettings.xml.
   * !AUTH_INFO! - информация о аутентификации на сервере БД. Заполняется соответствующими значениями из переменной CONNECTION_STRING из DirectumRxWebLocal\api\\_ConfigSettings.xml. Какими именно - зависит от используемой СУБД и способа аутентификации. Например: value="Integrated Security=False;User ID=UserID;Password=Password" или value="Integrated Security=True"
   * !DATABASE_ENGINE! - используемый движок сервера БД. Заполняется значением переменной DATABASE_ENGINE из DirectumRxWebLocal\api\\_ConfigSettings.xml.
   * !QUEUE_CONNECTION_STRING! - строка подключения к серверу RabbitMQ. Заполняется значением переменной QUEUE_CONNECTION_STRING из DirectumRxWebLocal\api\\_ConfigSettings.xml.
   * !CONNECTION_STRING! - при использовании MsSQL, как правило, не требует корректировок, но могут потребоваться корректировки для PostgreeSQL

После заполнения описания эталонного проекта необходимо на него переключиться. Для этого открыть powershell консоль, перейти в каталог rx-dds-manage-tools и выполнить скрипт change_project.ps1

```.\\c
.\change_project.ps1 -project_config c:\rx\3355\c_clr3355.xml
```

После переключения запустить DDS, выполнить публикацию  и проверить работоспособность системы.

В результате будет создан эталонный проект, который будет использоваться как основа для рабочих проектов.

### 3. Создание первого рабочего проекта на основе эталонного

Для создания рабочего проекта на основе эталонного необходимо (рассмотрим на примере создания проекта для работы над HR-Процессы):

1. Создать БД рабочего проекта на основе копии БД эталонного проекта. Например, на основе резервной копии БД rx_3355_clr создать БД rx3355_hr.

2. Создать корневой каталог с документами, скопировав копию корневого каталога с документами эталонного проекта. Например, каталог C:\RXData\3355\clr_3355 скопировать в C:\RXData\3355\hr

3. Создать каталог для исходников рабочего слоя проекта. Это можно сделать двумя способами:

   * клонировать соответствующий репозиторий
   * сделать копию каталога для исходников рабочего слоя. Например, каталог c:\rx\clr_work скопировать в каталог c:\rx\HRManagement

4. Создать файл описания проекта, скопировав файл c:\rx\3355\c_clr3355.xml в c:\rx\3355\c_hr.xml

5. Отредактировать файл описания проекта:

   * подкорректировать первый комментарий, чтобы не забыть назначение проекта

   * изменить значение переменной !DATABASE! - указать имя созданной БД (rx3355_hr)

   * изменить значение переменной !DOC_ROOT_DIRECTORY! - указать каталог документов (C:\RXData\3355\hr)

   * Скорректировать описание репозиториев:

         <block name="REPOSITORIES">	  
            <repository folderName="Box"            solutionType="Base" url=""/>
            <repository folderName="HRmanagement"   solutionType="Work" url="https://rxtfs.directum.ru/IS-Builder8/RXSolutions/_git/HRmanagement"/>
         </block>

6. Переключиться на созданный проект. Для этого открыть powershell консоль, перейти в каталог rx-dds-manage-tools и выполнить скрипт change_project.ps1

```.\\c
.\change_project.ps1 -project_config c:\rx\3355\c_hr.xml
```

После переключения необходимо запустить DDS и выполнить публикацию.

В дальнейшем использую скрипт change_project.ps1 можно переключаться между разными проектами внутри одной версии RX.  При этом следует соблюдать два правила:

1. Выгружать DDS перед переключением проекта
2. Запускать DDS и выполнять публикацию после переключения проекта.

Создание второго и последующих рабочих проектов происходит аналогично. При  этом в качестве основы можно использовать как эталонный проект, так и любой из рабочих.



Если для проекта потребуется принимать пакеты разработки на базовый слой, то для них рекомендуется создать отдельный каталог, чтобы оставить каталог "Box" в неизменном виде. В этом случае описание репозиториев может выглядеть так:

```
<block name="REPOSITORIES">	  
   <repository folderName="HRmanagement_base" solutionType="Base" url=""/>
   <repository folderName="Box"  solutionType="Base" url=""/>
   <repository folderName="HRmanagement"   solutionType="Work" url="https://rxtfs.directum.ru/IS-Builder8/RXSolutions/_git/HRmanagement"/>
</block>
```

**Внимание!** Важно, чтобы каталог, в который будут приниматься пакеты разработки был выше каталога Box, указанного в конфигурационном файле. В этом случае DDS будет принимать пакеты именно в этот каталог.



### 4. Подготовка к установке второй версии RX

1. Остановить все сервисы RX, воспользовавшись скриптом .\stop-rx.ps1
2. На C:-диске (или на любом другом) создать каталог, в котором будут храниться версии RX. Например, C:\rx_version.
3. В созданном каталоге создать каталог для хранения программных файлов установленной в данный момент версии RX. Например, c:\rx_version\3355
4. Перенести (именно «вырезать» папки и потом «вставить» ) в этот каталог каталоги C:\inetpub\wwwroot и C:\Program Files\Directum Company\Sungero Development Studio. Если не удается перенести файлы, то проверьте, все ли службы Directum RX остановлены. Остановите службы и повторите попытку переноса.
5. В каждом из этих каталогов создать пустой файл, в имени которого будет отражена версия RX. Например, "3.5.55.txt". Это позволит легко определять какая версия RX активна в данный момент.
6. "Переключиться" на текущую версию RX. Для этого открыть powershell консоль, перейти в каталог rx-dds-manage-tools и выполнить скрипт change_rxversion.ps1

```.\\c
.\change_rxversion.ps1 -pathTargetVersion C:\rx_versions\3355\
```

В результате будут созданы символические ссылки "с:\inetpub\wwwroot" и "C:\Program Files\Directum Company\Sungero Development Studio", которые будут ссылаться на "c:\rx_version\3355\wwwroot" и "c:\rx_version\3355\\Sungero Development Studio". 

Что бы убедиться, что символическая ссылка создана, необходимо вызвать контекстное меню и просмотреть свойства папки "с:\inetpub\wwwroot":

При первом запуске скрипта возможна ошибка, что символическая ссылка не найдена - это нормально.

После переключения на версию RX соответствующие службы будут остановлены, т.к. после  этого, как правило, надо переключиться на конкретный проект. А в ходе переключения все службы останавливаются и запускаются заново.

### 5. Установка второй версии RX

Рекомендуемый способ установки второй версии RX - это установка в режиме обновления.

Подготовка к обновлению (на примере обновления RX 3.3.55 на RX 3.4.21):

1. Остановить все сервисы RX, воспользовавшись скриптом .\stop-rx.ps1
2. Сделать копию каталога хранения программных файлов версии RX. Например, если планируется обновить RX 3.3.55 на RX 3.4.21, то каталог c:\rx_version\3355 скопировать в каталог c:\rx_version\3421
3. Переключиться на эту "новую" версию RX

```.\\c
.\change_rxversion.ps1 -pathTargetVersion C:\rx_versions\3421\
```

4. На основе эталонного проекта для RX 3.3.55 создать эталонный проект для 3.4.21 и переключиться на него. Например:
   * создать БД rx_3421_clr на основе резервной копии rx_3421_clr 
   * создать копию корневого каталога хранения документов: C:\RXData\3355\clr_3355 --> C:\RXData\3421\clr_3421
   * создать копию каталога исходников: C:\RX\3355\clr_Base --> C:\RX\3421\clr_Base, C:\RX\3355\clr_Work --> C:\RX\3421\clr_Work
   * создать файл описания проекта. Рекомендуется взять  образец файла и заполнить его. Например, для RX 3.4 - temp\sample_config_rx34.xml

Обновление версии RX:

1. Запустить обновление версии RX, запустив инсталлятор в режиме обновления.
2. Сделать копию каталога  C:\RX\3421\clr_Base -->  C:\RX\3421\Box

В результате на компьютере будет установлена еще одна версия RX и будет сконвертирована БД  эталонного проекта. При этом все предыдущие версии RX также сохраняться на компьютере и будет возможность переключаться между ними.

Для того что бы переключаться между версиями необходимо использовать скрипт .\change_rxversion.ps1




### Ограничения, особенности, лайф-хаки
* скрипты рассчитаны на запуск из текущего каталога
* после переключения на проект первую публикацию необходимо выполнять в режиме "Выборочная публикация"

* 